<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=1280, initial-scale=0.66, maximum-scale=1, user-scalable=no">
    <title>Pan/Tilt Camera</title>
    <link rel="apple-touch-icon" href="static/app.png">
    <link rel="stylesheet" href="static/jquery-ui.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #222;
            color: #ddd;
            font-family: Arial, Helvetica, Sans-Serif, serif;
            font-size: 24px;
        }

        #container {
            width: 100%;
            height: 1080px;
            position: relative;
        }

        #controls {
            width: 100%;
            padding: 5px 10px;
        }

        .overlay {
            cursor: pointer;
            border-radius: 8px;
            margin: 10px;
            padding: 8px;
            font-weight: bold;
            position: absolute;
            left: 20px;
            background-color: #444;
            opacity: 0.5;
        }

        .ui {
            opacity: 0.5;
            transition: opacity 1s linear;
        }

        #reload, #toggle {
            margin: 0;
            padding: 0;
            width: 64px;
            height: 64px;
            background-repeat: no-repeat;
            background-position-y: 4px;
        }

        #reload {
            top: 80px;
            background-image: url('static/reload.png');
        }

        #toggle {
            display: none;
            top: 200px;
            background-image: url('static/lock.png');
        }

        #positioncontainer {
            opacity: 0;
            transition: opacity 1s linear;
            border: solid #ccc 2px;
            width: 320px;
            height: 90px;
            margin: auto;
            top: 540px;
            position: relative;
        }

        #position {
            position: relative;
            top: 37px;
            left: 152px;
            width: 16px;
            height: 16px;
            border-radius: 8px;
            background-color: #ccc;
        }

        .bottom-left, .top-left, .top-right, .bottom-right {
            position: absolute;
        }

        .bottom-left { bottom: 8px; left: 16px; }
        .top-left { top: 8px; left: 16px; }
        .top-right { top: 8px; right: 16px; }
        .bottom-right { bottom: 8px; right: 16px; }

        .centered {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
    <script src="static/jquery-1.12.4.min.js"></script>
    <script src="static/jquery-ui.min.js"></script>
    <script src="static/socket.io.js"></script>
    <script>
        $(document).ready(function () {
            const fusionFeed = '{{ url_for('fusion_video_feed') }}';
            const thermalFeed = '{{ url_for('thermal_video_feed') }}';
            const visibleFeed = '{{ url_for('visible_video_feed') }}';
            const socket = io.connect(`${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.hostname}:${location.port || (location.protocol === 'https:' ? 443 : 80)}${location.pathname}`);

            let currentFeed = 0;
            let isThermalOn = false;
            let isLaserOn = false;
            let gamepadIndex;

            function changeChannel(channel) {
                $("#primary_video").attr("src", '');
                setTimeout(() => {
                    $("#primary_video").attr("src", {
                        'Fusion': fusionFeed,
                        'Thermal': thermalFeed,
                        'Optical': visibleFeed
                    }[channel]);
                    $("#channel").text(channel);
                }, 1000);
            }

            function switchChannels() {
                currentFeed = (currentFeed + 1) % 3;
                changeChannel(['Optical', 'Thermal', 'Fusion'][currentFeed]);
            }

            function toggleThermal() {
                socket.emit('cmd', { 'cmd': isThermalOn ? 'thermal-off' : 'thermal-on' });
                isThermalOn = !isThermalOn;
                $("#thermal").text(isThermalOn ? 'Thermal ON' : 'Thermal OFF');
            }

            function handleGamepadInput() {
                const myGamepad = navigator.getGamepads()[gamepadIndex];
                if (!myGamepad) return;

                if (myGamepad.axes.some(axis => axis.toFixed(2) != 0.00)) {
                    const [pan, tilt, zoom, focus] = myGamepad.axes.map(axis => parseFloat(axis.toFixed(2)));
                    socket.emit('motion', { pan: -pan, tilt: tilt, relative: true });
                    socket.emit('optic', { zoom: zoom, focus: -focus, relative: true });
                }

                myGamepad.buttons.forEach((button, index) => {
                    if (button.pressed) {
                        const actions = [
                            () => changeChannel('Fusion'), () => changeChannel('Optical'), () => changeChannel('Thermal'),
                            () => socket.emit('cmd', { 'cmd': 'ir-cut' }), null, null,
                            () => socket.emit('cmd', { 'cmd': 'min-zoom' }), () => socket.emit('cmd', { 'cmd': 'max-zoom' }),
                            switchChannels, toggleThermal,
                            () => { socket.emit('cmd', { 'cmd': 'laser-off' }); isLaserOn = false; },
                            () => { socket.emit('cmd', { 'cmd': 'laser-on' }); isLaserOn = true; },
                            toggleThermal, switchChannels, () => socket.emit('cmd', { 'cmd': 'ir-cut' }), null
                        ];
                        actions[index]?.();
                    }
                });
            }

            window.addEventListener('gamepadconnected', event => {
                gamepadIndex = event.gamepad.index;
                setInterval(handleGamepadInput, 100);
            });

            socket.on('connect', () => socket.emit('handshake', { data: 'I\'m connected!' }));
            socket.on('handshake', data => {
                $("#pantilt").text(`Pan: ${data.start_horizontal} Tilt: ${data.start_vertical}`);
                isThermalOn = data.thermal_status;
                $("#primary_video").attr("src", fusionFeed);
            });

            $("#reload").click(() => location.reload());
            $("#toggle").click(switchChannels);
            $(document).keydown(event => {
                const amount = event.shiftKey ? 5 : 1;
                if (event.ctrlKey) {
                    if (event.shiftKey && event.key === 'R') socket.emit('cmd', { 'cmd': 'restart' });
                    else if (event.key === 't') socket.emit('cmd', { 'cmd': 'thermal-on' });
                    else if (['a', 'b', 'c', 'd'].includes(event.key)) socket.emit('cmd', { 'cmd': 'setPos', 'pos': event.key });
                } else {
                    const keys = {
                        37: () => socket.emit('motion', { pan: amount, tilt: 0, relative: true }),
                        38: () => socket.emit('motion', { pan: 0, tilt: amount, relative: true }),
                        39: () => socket.emit('motion', { pan: -amount, tilt: 0, relative: true }),
                        40: () => socket.emit('motion', { pan: 0, tilt: -amount, relative: true }),
                        '0': () => { currentFeed = 0; changeChannel('Optical'); },
                        '1': () => { currentFeed = 0; changeChannel('Optical'); },
                        '2': () => { currentFeed = 1; changeChannel('Thermal'); },
                        '3': () => { currentFeed = 2; changeChannel('Fusion'); },
                        't': toggleThermal,
                        'h': () => $('#help').css('opacity', $('#help').css('opacity') === '0' ? 1 : 0)
                    };
                    if (keys[event.keyCode]) keys[event.keyCode]();
                    else if (keys[event.key]) keys[event.key]();
                }
            });

            $('#container').on('mousedown', e => {
                $('#container').css('cursor', 'grab');
                lp = e.pageX;
                lt = e.pageY;
                tracking = true;
            }).on('mousemove', e => {
                if (tracking) {
                    const pv = (e.pageX - lp) / 4;
                    const tv = (e.pageY - lt) / 4;
                    if (pv || tv) {
                        socket.emit('motion', { pan: pv, tilt: tv, relative: true });
                        lp = e.pageX;
                        lt = e.pageY;
                    }
                }
            }).on('mouseup', () => {
                tracking = false;
                $('#container').css('cursor', 'default');
            });

            showUIOverlay();
        });

        function showUIOverlay() {
            $('.ui').css('opacity', 0.5);
        }
    </script>
</head>
<body>
<div id="container">
    <img id="primary_video" style="width: 100%" src="">
    <div class="bottom-left" id="pantilt">Pan: "No Data" Tilt: "No Data"</div>
    <div class="top-left" id="compass"></div>
    <div class="top-right" id="thermal">Thermal Off</div>
    <div class="bottom-right" id="channel"></div>
    <div id="controls">
        <div class="overlay ui" id="reload"></div>
        <div class="overlay ui" id="toggle"></div>
    </div>
    <div class="ui" id="positioncontainer">
        <div id="position"></div>
    </div>
</div>
</body>
</html>
