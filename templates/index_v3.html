<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Enhanced Military Vehicle PTZ UI</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #d4d4d4;
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 15%;
            background-color: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-right: 2px solid #444;
        }

        .sidebar .thumbnail {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: #d4d4d4;
            border: 2px solid #444;
            cursor: pointer;
        }

        .sidebar .thumbnail.active {
            border-color: #00ff00;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #1a1a1a;
            border-bottom: 2px solid #444;
            position: relative;
        }

        .heading-indicator {
            font-size: 18px;
            color: #00ff00;
        }

        .vehicle-data {
            font-size: 14px;
        }

        .camera-feed {
            flex: 2;
            background-color: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 2px solid #444;
        }

        .camera-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #00ff00;
            font-size: 24px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .ptz-off-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff0000;
            font-size: 36px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px 40px;
            border-radius: 10px;
            display: none;
        }

        .ptz-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .joystick {
            width: 100px;
            height: 100px;
            background-color: #333;
            border: 2px solid #00ff00;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            touch-action: none;
        }

        .joystick-handle {
            width: 40px;
            height: 40px;
            background-color: #00ff00;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .action-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #1a1a1a;
            border-top: 2px solid #444;
            position: relative;
        }

        .action-bar button {
            background-color: #333;
            color: #d4d4d4;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .action-bar button:hover {
            background-color: #444;
        }

        .action-bar button.active {
            border-color: #00ff00;
            color: #00ff00;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .toggle-button {
            background-color: #333;
            color: #d4d4d4;
            border: none;
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 3px;
            cursor: pointer;
        }

        .toggle-button:hover {
            background-color: #444;
        }

        .gamepad-status {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 18px;
        }

        .gamepad-status.connected {
            color: #00ff00;
        }

        .gamepad-status.disconnected {
            color: #555;
        }

        /* PiP video styling */
        #pipVideo {
            position: absolute;
            width: 35%;
            height: 35%;
            bottom: 10px;
            right: 10px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            object-fit: cover;
            display: none;
            background: #000;
        }
    </style>
    <script src="static/mgrs.min.js"></script>
</head>
<body>
<div class="sidebar">
    <div class="thumbnail" data-camera="Front Camera">Front Thermal Camera</div>
    <div class="thumbnail active" data-camera="PTZ Thermal Camera">PTZ Thermal Camera</div>
    <div class="thumbnail" data-camera="PTZ Visible Camera">PTZ Visible Camera</div>
</div>
<div class="main-container">
    <div class="header">
        <div class="heading-indicator">Heading: N 45¬∞</div>
        <div class="vehicle-data" id="vehicle-data">Lat: N/A, Lon: N/A, MGRS: N/A</div>
    </div>
    <div class="camera-feed">
        <video id="cameraVideo" autoplay playsinline muted></video>
        <video id="pipVideo" autoplay playsinline muted></video>
        <div class="camera-overlay" id="cameraOverlay">
            PTZ Rotation: N/A<br>
            Tilt: N/A
        </div>
        <div class="ptz-off-message" id="ptz-off-message">PTZ OFF</div>
        <div class="ptz-controls">
            <div class="joystick" id="touch-joystick">
                <div class="joystick-handle" id="joystick-handle"></div>
            </div>
            <button class="toggle-button" id="toggle-thermal">Thermal / Visible</button>
        </div>
    </div>
    <div class="action-bar">
        <button id="power-ptz">PTZ Power</button>
        <button id="power-visible-light">Visible Light</button>
        <button id="power-ir-light">IR Light</button>
        <button id="default-position">Default Position</button>
        <button id="scan-button">Scan</button>
        <button id="pip-button">üñºÔ∏è PiP</button>
        <div class="gamepad-status disconnected">üéÆ</div>
    </div>
</div>

<script src="static/socket.io.js"></script>
<script>
    const socket = io();

    const cameraSources = {
        "PTZ Thermal Camera": "http://localhost:1984/api/webrtc?src=PTZ_Thermal",
        "PTZ Visible Camera": "http://localhost:1984/api/webrtc?src=PTZ_Visual",
        "Front Camera": "http://localhost:1984/api/webrtc?src=Front_Camera"
    };

    let pc = null;
    let pipPc = null; // For PiP
    let currentCamera = "PTZ Thermal Camera";

    let visibleLightOn = false;
    let irLightOn = false;
    let cameraOn = false; // PTZ power
    let scanning = false;
    let gamepadConnected = false;
    let locationRequested = false;
    let pipOn = false; // PiP state

    const gamepadStatusEl = document.querySelector('.gamepad-status');
    const vehicleDataEl = document.getElementById('vehicle-data');
    const ptzOffMessageEl = document.getElementById('ptz-off-message');
    const pipVideo = document.getElementById('pipVideo');

    socket.on('connect', () => {
        console.log("Connected to server");
        socket.emit('handshake');
    });

    socket.on('ptz-angles', (data) => {
        const overlay = document.getElementById('cameraOverlay');
        overlay.innerHTML = `PTZ Rotation: ${data.horizontal.toFixed(2)}¬∞<br>Tilt: ${data.vertical.toFixed(2)}¬∞`;
    });

    async function playWebRTCStream(webrtcUrl) {
        if (pc) {
            pc.getSenders().forEach(sender => sender.track && sender.track.stop());
            pc.getReceivers().forEach(receiver => receiver.track && receiver.track.stop());
            pc.close();
        }

        pc = new RTCPeerConnection();
        pc.addTransceiver('video', {direction: 'recvonly'});

        pc.ontrack = event => {
            const video = document.getElementById('cameraVideo');
            video.srcObject = event.streams[0];
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        const response = await fetch(webrtcUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({type: 'offer', sdp: offer.sdp})
        });

        if (!response.ok) {
            console.error(`Error from go2rtc: ${response.status}`);
            return;
        }

        const answer = await response.json();
        await pc.setRemoteDescription(new RTCSessionDescription(answer));

        updatePTZOffMessage();
        updatePiP(); // if PiP is on, refresh PiP stream too
    }

    async function playPiPStream() {
        // Determine which camera to show in PiP
        let pipCamera = null;
        if (currentCamera === "PTZ Thermal Camera") {
            pipCamera = "PTZ Visible Camera";
        } else if (currentCamera === "PTZ Visible Camera") {
            pipCamera = "PTZ Thermal Camera";
        } else {
            // If main camera is front, no PiP
            pipVideo.style.display = 'none';
            if (pipPc) {
                pipPc.close();
                pipPc = null;
            }
            return;
        }

        const webrtcUrl = cameraSources[pipCamera];

        if (pipPc) {
            pipPc.getSenders().forEach(s => s.track && s.track.stop());
            pipPc.getReceivers().forEach(r => r.track && r.track.stop());
            pipPc.close();
        }

        pipPc = new RTCPeerConnection();
        pipPc.addTransceiver('video', {direction: 'recvonly'});

        pipPc.ontrack = event => {
            pipVideo.srcObject = event.streams[0];
        };

        const offer = await pipPc.createOffer();
        await pipPc.setLocalDescription(offer);

        const response = await fetch(webrtcUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({type: 'offer', sdp: offer.sdp})
        });

        if (!response.ok) {
            console.error(`PiP error from go2rtc: ${response.status}`);
            pipVideo.style.display = 'none';
            return;
        }

        const answer = await response.json();
        await pipPc.setRemoteDescription(new RTCSessionDescription(answer));

        // Show pip video
        pipVideo.style.display = pipOn ? 'block' : 'none';
    }

    function updatePiP() {
        if (pipOn && (currentCamera === "PTZ Thermal Camera" || currentCamera === "PTZ Visible Camera")) {
            playPiPStream();
        } else {
            // Turn off pip
            pipVideo.style.display = 'none';
            if (pipPc) {
                pipPc.getSenders().forEach(s => s.track && s.track.stop());
                pipPc.getReceivers().forEach(r => r.track && r.track.stop());
                pipPc.close();
                pipPc = null;
            }
        }
    }

    // Start with the PTZ Thermal camera
    playWebRTCStream(cameraSources[currentCamera]);

    const thumbnails = document.querySelectorAll('.sidebar .thumbnail');
    thumbnails.forEach(thumb => {
        thumb.addEventListener('click', () => {
            thumbnails.forEach(t => t.classList.remove('active'));
            thumb.classList.add('active');
            const cameraName = thumb.getAttribute('data-camera');
            currentCamera = cameraName;
            if (cameraSources[cameraName]) {
                playWebRTCStream(cameraSources[cameraName]);
            } else {
                console.warn(`No source defined for ${cameraName}`);
            }

            if (!locationRequested) {
                locationRequested = true;
                requestLocation();
            }
        });
    });

    function updatePTZOffMessage() {
        if (!cameraOn && (currentCamera === "PTZ Thermal Camera" || currentCamera === "PTZ Visible Camera")) {
            ptzOffMessageEl.style.display = 'block';
        } else {
            ptzOffMessageEl.style.display = 'none';
        }
    }

    const deadzone = 0.3;
    const baseSpeed = 1.0;
    let gamepadIndex = null;

    let lastEmitTime = 0;
    const emitInterval = 500; // ms
    let lastPan = 0, lastTilt = 0, lastSpeed = 0;
    let hasStopped = false;
    let lastButtonStates = [];

    window.addEventListener('gamepadconnected', (e) => {
        console.log(`Gamepad connected: ${e.gamepad.id}`);
        gamepadIndex = e.gamepad.index;
        gamepadConnected = true;
        updateGamepadIcon();
        requestAnimationFrame(pollGamepad);
    });
    window.addEventListener('gamepaddisconnected', () => {
        gamepadIndex = null;
        gamepadConnected = false;
        updateGamepadIcon();
    });

    function updateGamepadIcon() {
        if (gamepadConnected) {
            gamepadStatusEl.classList.add('connected');
            gamepadStatusEl.classList.remove('disconnected');
        } else {
            gamepadStatusEl.classList.remove('connected');
            gamepadStatusEl.classList.add('disconnected');
        }
    }

    function normalize(value, deadzone) {
        if (Math.abs(value) < deadzone) return 0;
        const sign = Math.sign(value);
        const adjusted = (Math.abs(value) - deadzone) / (1 - deadzone);
        return sign * adjusted;
    }

    function pollGamepad() {
        if (gamepadIndex === null) {
            requestAnimationFrame(pollGamepad);
            return;
        }

        const gp = navigator.getGamepads()[gamepadIndex];
        if (!gp) {
            requestAnimationFrame(pollGamepad);
            return;
        }

        handleGamepadJoystick(gp);
        handleGamepadButtons(gp);

        requestAnimationFrame(pollGamepad);
    }

    function handleGamepadJoystick(gp) {
        let pan = normalize(gp.axes[0], deadzone);
        let tilt = -normalize(gp.axes[1], deadzone);
        handleMotion(pan, tilt);
    }

    function handleGamepadButtons(gp) {
        if (lastButtonStates.length === 0) {
            lastButtonStates = gp.buttons.map(b => b.pressed);
        }

        gp.buttons.forEach((button, index) => {
            const wasPressed = lastButtonStates[index];
            const isPressed = button.pressed;
            if (!wasPressed && isPressed) {
                switch (index) {
                    case 17: // PTZ Power
                        cameraOn = !cameraOn;
                        socket.emit('cmd', {cmd: cameraOn ? 'PTZ-on' : 'PTZ-off'});
                        updateButtonState();
                        updatePTZOffMessage();
                        break;
                    case 1: // Visible Light
                        visibleLightOn = !visibleLightOn;
                        socket.emit('cmd', {cmd: visibleLightOn ? 'lights-on' : 'lights-off'});
                        updateButtonState();
                        break;
                    case 2: // IR Light
                        irLightOn = !irLightOn;
                        socket.emit('cmd', {cmd: irLightOn ? 'ir-lights-on' : 'ir-lights-off'});
                        updateButtonState();
                        break;
                    case 3: // Default Position
                        socket.emit('cmd', {cmd: 'default-position'});
                        break;
                    case 4: // Scan
                        scanning = !scanning;
                        socket.emit('cmd', {cmd: scanning ? 'start-scan' : 'stop-scan'});
                        updateButtonState();
                        break;
                    default:
                        // Other buttons if needed
                        break;
                }
            }
            lastButtonStates[index] = isPressed;
        });
    }

    // Touch joystick logic
    const joystick = document.getElementById('touch-joystick');
    const joystickHandle = document.getElementById('joystick-handle');
    let touchActive = false;
    let joystickCenterX, joystickCenterY;

    joystick.addEventListener('touchstart', (e) => {
        e.preventDefault();
        touchActive = true;
        const rect = joystick.getBoundingClientRect();
        joystickCenterX = rect.x + rect.width / 2;
        joystickCenterY = rect.y + rect.height / 2;
    }, {passive: false});

    joystick.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!touchActive) return;
        const touch = e.touches[0];
        const dx = touch.clientX - joystickCenterX;
        const dy = touch.clientY - joystickCenterY;
        const maxRadius = 50; // half joystick size
        const distance = Math.min(maxRadius, Math.sqrt(dx * dx + dy * dy));

        const angle = Math.atan2(dy, dx);
        const x = distance * Math.cos(angle);
        const y = distance * Math.sin(angle);

        joystickHandle.style.transform = `translate(${x}px, ${y}px)`;

        let pan = x / maxRadius;   // range approx -1 to 1
        let tilt = -y / maxRadius; // invert Y
        if (Math.abs(pan) < deadzone) pan = 0;
        if (Math.abs(tilt) < deadzone) tilt = 0;

        handleMotion(pan, tilt);
    }, {passive: false});

    joystick.addEventListener('touchend', (e) => {
        e.preventDefault();
        touchActive = false;
        joystickHandle.style.transform = `translate(-50%, -50%)`;
        socket.emit('stop'); // stop motion when touch ends
    }, {passive: false});

    function handleMotion(pan, tilt) {
        const speedFactor = Math.max(Math.abs(pan), Math.abs(tilt)) * baseSpeed;
        const now = performance.now();
        const panDiff = Math.abs(pan - lastPan);
        const tiltDiff = Math.abs(tilt - lastTilt);
        const speedDiff = Math.abs(speedFactor - lastSpeed);

        const inDeadzone = (pan === 0 && tilt === 0);

        if (inDeadzone) {
            if (!hasStopped) {
                socket.emit('stop');
                hasStopped = true;
            }
        } else {
            hasStopped = false;
            if ((panDiff > 0.05 || tiltDiff > 0.05 || speedDiff > 0.05) && (now - lastEmitTime > emitInterval)) {
                socket.emit('motion', {pan, tilt, speed: speedFactor});
                lastPan = pan;
                lastTilt = tilt;
                lastSpeed = speedFactor;
                lastEmitTime = now;
            }
        }
    }

    const powerPtzBtn = document.getElementById('power-ptz');
    const powerVisibleLightBtn = document.getElementById('power-visible-light');
    const powerIrLightBtn = document.getElementById('power-ir-light');
    const defaultPositionBtn = document.getElementById('default-position');
    const scanBtn = document.getElementById('scan-button');
    const pipBtn = document.getElementById('pip-button');

    powerPtzBtn.addEventListener('click', () => {
        cameraOn = !cameraOn;
        socket.emit('cmd', {cmd: cameraOn ? 'PTZ-on' : 'PTZ-off'});
        updateButtonState();
        updatePTZOffMessage();
    });

    powerVisibleLightBtn.addEventListener('click', () => {
        visibleLightOn = !visibleLightOn;
        socket.emit('cmd', {cmd: visibleLightOn ? 'lights-on' : 'lights-off'});
        updateButtonState();
    });

    powerIrLightBtn.addEventListener('click', () => {
        irLightOn = !irLightOn;
        socket.emit('cmd', {cmd: irLightOn ? 'ir-lights-on' : 'ir-lights-off'});
        updateButtonState();
    });

    defaultPositionBtn.addEventListener('click', () => {
        socket.emit('cmd', {cmd: 'default-position'});
    });

    scanBtn.addEventListener('click', () => {
        scanning = !scanning;
        socket.emit('cmd', {cmd: scanning ? 'start-scan' : 'stop-scan'});
        updateButtonState();
    });

    pipBtn.addEventListener('click', () => {
        pipOn = !pipOn;
        updatePiP();
    });

    document.getElementById('toggle-thermal').addEventListener('click', () => {
        socket.emit('cmd', {cmd: 'toggleThermal'});
    });

    function updateButtonState() {
        powerPtzBtn.classList.toggle('active', cameraOn);
        powerVisibleLightBtn.classList.toggle('active', visibleLightOn);
        powerIrLightBtn.classList.toggle('active', irLightOn);
        scanBtn.classList.toggle('active', scanning);
        pipBtn.classList.toggle('active', pipOn);
    }

    updateButtonState();
    updatePTZOffMessage();

    function requestLocation() {
        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    const mgrsStr = mgrs.forward([lon, lat], 5);
                    vehicleDataEl.textContent = `Lat: ${lat.toFixed(4)}¬∞, Lon: ${lon.toFixed(4)}¬∞, MGRS: ${mgrsStr}`;
                },
                (err) => {
                    console.warn(`GPS error: ${err.message}`);
                    vehicleDataEl.textContent = `Lat: N/A, Lon: N/A, MGRS: N/A (GPS unavailable)`;
                },
                {enableHighAccuracy: true, timeout: 10000, maximumAge: 0}
            );
        } else {
            vehicleDataEl.textContent = `Lat: N/A, Lon: N/A, MGRS: N/A (GPS not supported)`;
        }
    }
</script>
</body>
</html>
