<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PTZ Control</title>
    <script src="static/socket.io.js"></script>
</head>
<body>
<h1>PTZ Control via Gamepad</h1>
<p>Connect a gamepad and move the left stick to control the camera.</p>

<script>
    const socket = io();
    const deadzone = 0.3;
    const baseSpeed = 1.0;
    let gamepadIndex = null;

    let lastEmitTime = 0;
    const emitInterval = 500; // ms
    let lastPan = 0, lastTilt = 0, lastSpeed = 0;
    let hasStopped = false;

    let visibleLightOn = false;
    let irLightOn = false;
    let cameraOn = false;
    let scanning = false;
    let lastButtonStates = [];

    function normalize(value, deadzone) {
        if (Math.abs(value) < deadzone) return 0;
        const sign = Math.sign(value);
        const adjusted = (Math.abs(value) - deadzone) / (1 - deadzone);
        return sign * adjusted;
    }

    socket.on('connect', () => {
        console.log("Connected to server");
        socket.emit('handshake'); // Send handshake on connect
    });

    socket.on('ptz-angles', (data) => {
        // data: {horizontal: number, vertical: number}
        console.log(`Horizontal: ${data.horizontal}, Vertical: ${data.vertical}`);
        // Update UI elements if needed
    });


    window.addEventListener('gamepadconnected', (e) => {
        console.log(`Gamepad connected: ${e.gamepad.id}`);
        gamepadIndex = e.gamepad.index;
        requestAnimationFrame(pollGamepad);
    });

    function pollGamepad() {
        if (gamepadIndex === null) {
            requestAnimationFrame(pollGamepad);
            return;
        }

        const gp = navigator.getGamepads()[gamepadIndex];
        if (!gp) {
            requestAnimationFrame(pollGamepad);
            return;
        }

        handleJoystick(gp);
        handleButtons(gp);

        requestAnimationFrame(pollGamepad);
    }

    function handleJoystick(gp) {
        let pan = normalize(gp.axes[0], deadzone);
        let tilt = -normalize(gp.axes[1], deadzone); // invert so up is positive
        const speedFactor = Math.max(Math.abs(pan), Math.abs(tilt)) * baseSpeed;

        const now = performance.now();
        const panDiff = Math.abs(pan - lastPan);
        const tiltDiff = Math.abs(tilt - lastTilt);
        const speedDiff = Math.abs(speedFactor - lastSpeed);

        const inDeadzone = (Math.abs(pan) < deadzone && Math.abs(tilt) < deadzone);

        if (inDeadzone) {
            if (!hasStopped) {
                socket.emit('stop');
                hasStopped = true;
            }
        } else {
            hasStopped = false;
            if ((panDiff > 0.05 || tiltDiff > 0.05 || speedDiff > 0.05) && (now - lastEmitTime > emitInterval)) {
                socket.emit('motion', { pan, tilt, speed: speedFactor });
                lastPan = pan;
                lastTilt = tilt;
                lastSpeed = speedFactor;
                lastEmitTime = now;
            }
        }
    }

    function handleButtons(gp) {
        if (lastButtonStates.length === 0) {
            lastButtonStates = gp.buttons.map(b => b.pressed);
        }

        // Button Mappings:
        // A (0): Toggle visible light
        // B (1): Toggle IR light
        // X (2): Toggle Camera On/Off
        // Y (3): Default Position

        gp.buttons.forEach((button, index) => {
            const wasPressed = lastButtonStates[index];
            const isPressed = button.pressed;
            if (!wasPressed && isPressed) {
                handleButtonPress(index);
            }
            lastButtonStates[index] = isPressed;
        });
    }

    function handleButtonPress(buttonIndex) {
        switch (buttonIndex) {
            case 0: // A: Toggle visible light
                visibleLightOn = !visibleLightOn;
                socket.emit('cmd', { cmd: visibleLightOn ? 'lights-on' : 'lights-off' });
                break;
            case 1: // B: Toggle IR light
                irLightOn = !irLightOn;
                socket.emit('cmd', { cmd: irLightOn ? 'ir-lights-on' : 'ir-lights-off' });
                break;
            case 2: // X: Start Scanning
                scanning = !scanning;
                socket.emit('cmd', { cmd: scanning ? 'start-scan' : 'stop-scan' });
                break;
            case 3: // Y: Default Position
                socket.emit('cmd', { cmd: 'default-position' });
                break;
             case 17: // X: Toggle Camera On/Off
                cameraOn = !cameraOn;
                socket.emit('cmd', { cmd: cameraOn ? 'PTZ-on' : 'PTZ-off' });
                break;
            default:
                // Add more buttons if needed
                break;
        }
    }
</script>
</body>
</html>
